### **Проект "Synopsis": Спецификация**

#### **Часть I: Философия и Концепция**

**1. Видение:** Создать децентрализованную, саморегулируемую и прозрачную аналитическую среду для работы со знаниями. Цель — не дать один "правильный" ответ, а предоставить пользователям инструменты для критического сравнения различных, подтвержденных источниками точек зрения.

**2. Ключевые принципы:**
*   **Атомарность Контента:** Основа всего — **блок**, а не статья.
*   **Конкуренция Альтернатив:** Каждая смысловая единица (блок, свойство) существует в виде набора конкурирующих альтернатив.
*   **Обязательная Верификация:** Каждое изменение (коммит) требует привязки к внешнему источнику.
*   **Демократия и Репутация:** Сообщество определяет наиболее релевантные версии путем голосования, а вес голоса и права зависят от репутации (кармы) пользователя.
*   **Семантическая Связность:** Система "понимает" смысл контента через иерархическую, векторную систему концептов (тегов и свойств).

---

#### **Часть II: Архитектура и Техническая Реализация**

**1. Основная Архитектура: "Реактивный Воркер" с гибридной раздачей статики**

*   **Ядро Системы:** монорепа на nestjs разделенная на приложения, которое управляет всей логикой.
*   **Воркеры:** реагируют на события мгновенно, выполняя все ресурсоемкие задачи (генерация статики, AI-анализ) в фоновых очередях.
*   **Статика:** Логика рендеринга Markdown и сборки блоков реализована в виде единого модуля, который используется и Воркером при генерации статики, и на фронтенде при динамическом обновлении.
*   **Хранение Контента (Git):**
    *   **Локальные Репозитории:** Каждая статья хранится в отдельном bare Git-репозитории на локальном сервере (`/data/git/article-slug.git`). Это обеспечивает скорость и изоляцию.
    *   **Структура Файлов:** Внутри репозитория каждая альтернатива — это отдельный Markdown-файл (`ru/b001-heading.md`, `en/b002-academic.md`). Имя файла несет семантическую информацию.
    *   **Мета-описание блоков:** Каждый блок хранит тело в `.md` файле, а его заголовок и уровень заголовка фиксируются в сопутствующих метаданных (БД и `manifest.json`). Это обеспечивает единообразную структуру страницы и позволяет фронтенду строить оглавление.
    *   **Коммиты:** API создает коммиты от имени пользователя, включая URL-источник в сообщение коммита.
*   **Хранение Метаданных (PostgreSQL):**
    *   Единая база PostgreSQL служит "мозгом" системы.
    *   Хранит `users`, `votes`, `discussions`, `search_index` (с векторами через `pgvector`), а также единую иерархическую таблицу `concepts`.
    *   Таблица `blocks` содержит не только тело блока, но и обязательные поля `title` и `heading_level`, чтобы интерфейсы и воркеры могли восстанавливать иерархию заголовков независимо от Markdown.
*   **Резервное копирование (GitHub):**
    *   Воркер периодически (например, раз в час) асинхронно выполняет `git push` из локальных репозиториев в публичные репозитории на GitHub.
    *   **GitHub используется строго как публичное "зеркало" и бэкап**, а не как основная рабочая инфраструктура, чтобы не нарушать ToS и избежать рисков блокировки.

**2. Раздача Контента (Гибридный подход):**

*   **Инфраструктура:** На основном сервере поднят **MinIO** (S3-совместимое хранилище) и веб-сервер **Nginx**.
*   **Процесс:**
    1.  Воркер после обработки коммита генерирует артефакты (`index.html`, `manifest.json`) и загружает их вместе со всеми `.md` файлами в MinIO.
    2.  Nginx настроен на раздачу статики напрямую из MinIO, кешируя запросы. Это обеспечивает S3-совместимость для будущего масштабирования.
*   **"Гидратация":**
    *   Анонимные пользователи получают быструю статическую страницу.
    *   Для авторизованных пользователей JavaScript "на лету" подгружает с API актуальные данные (голоса, комментарии) и обновляет DOM.

---

#### **Часть III: Функциональные Модули**

**1. Концепты: Универсальная Семантическая Сеть**

В основе всей системы лежит единая иерархическая сущность — **"Концепт"**. Это позволяет отказаться от искусственного разделения на "теги", "свойства" и "значения", превращая всю базу знаний в единый, связанный граф.

*   **Принцип "Всё есть Концепт":** Любая мета-информация, будь то категория ("Наука"), свойство ("Дата рождения") или конкретное значение ("1995-08-28"), является равноправным узлом (концептом) в графе.
*   **Структура данных (Таблица `concepts` в PG):**
    *   `id`: Первичный ключ.
    *   `key`: Уникальный, машиночитаемый, не зависящий от языка ключ (`'birth-date'`, `'1995-08-28'`). Используется для URL, API и внутренних связей.
    *   `parent_id`: Ссылка на родительский концепт. Создает иерархию и обеспечивает контекст (например, у концепта `'1995-08-28'` родитель — `'date'`).
    *   `type`: Определяет роль концепта в интерфейсе (`'category'`, `'property'`, `'value'`).
    *   `vector`: Векторное представление (`pgvector`) для семантического поиска и нахождения связей.
*   **Связь со статьей:** Статьи и блоки не хранят значения, а лишь ссылаются на `id` нужных концептов через связующие таблицы (`article_concepts`, `block_concepts`).
*   **Мультиязычность (Таблица `concept_labels`):** Хранит человекочитаемые представления для каждого концепта на разных языках (`concept_id`, `lang_code`, `label`). Это позволяет системе оперировать стабильным `key`, отображая пользователю локализованный текст.

**2. "Карточка Феномена": Динамическая Витрина Концептов**

"Карточка Феномена" — это не отдельная сущность, а динамически генерируемый интерфейс, который визуализирует связи статьи с концептами типа `'property'` и `'value'`.

*   **Процесс генерации:**
    1.  Для отображения карточки статьи (например, "Альберт Эйнштейн") система запрашивает все связанные с ней концепты.
    2.  Она находит концепты-значения, например: `{ key: '1879-03-14', parent_id: 5 }`.
    3.  Используя `parent_id`, она находит родительский концепт-свойство: `{ id: 5, key: 'birth-date' }`.
    4.  На основе этой пары (`родитель-потомок`) система рендерит в интерфейсе строку: **"Дата рождения: 1879-03-14"**.
*   **Интерактивность и Голосование:**
    *   Каждая строка в карточке — это не просто текст. "Дата рождения" — это ссылка на страницу концепта `'birth-date'`, а "1879-03-14" — ссылка на страницу концепта `'1879-03-14'`, где будут перечислены все другие статьи с этой датой.
    *   **Альтернативы и голосование применяются к самой *связи*** между статьей и концептом-значением. Если кто-то хочет оспорить дату рождения Эйнштейна, он предлагает новую связь: `статья "Альберт Эйнштейн" -> концепт "1879-03-15"`. Сообщество голосует за то, какая из этих двух связей является основной.

**3. AI-подсистема (локальные, легковесные модели):**

*   **AI-ассистент:** Фоновый процесс анализирует слишком "широкие" концепты и предлагает модераторам разделить их на более точные дочерние.
*   **Embedding:** Используются локальные модели (например, из семейства Qwen) для векторизации контента и концептов.
*   **Распознавание Сущностей (NER):** Легковесная LLM анализирует текст блока, извлекает потенциальные сущности и предлагает пользователю превратить их в ссылки. Промпт: `"Найди в тексте '...' все феномены и верни JSON-массив их базовых форм"`.
*   **Верификация Источников:** AI-воркер асинхронно скачивает (`Playwright`) и анализирует источник, помечая блок результатом проверки.
*   **Автоматические перводы** AI-воркер автоматически переводит блок на разные языки. 

**4. Git API:**
*   Серверное приложение напрямую взаимодействует с локальными Git-репозиториями через библиотеки (`simple-git`) для получения истории, diff'ов и метаданных коммитов для отображения в интерфейсе. Внешний API не требуется.
