# Реализация реактивного воркера и монорепы

## Контекст
Проект требует монорепозиторий на NestJS с разделением на приложения и реактивных воркеров, которые обрабатывают событийные очереди.

## Задачи
- Спроектировать структуру монорепы NestJS с ядром и отдельными приложениями (API, воркеры, фронтенд-рендерер).
  - Создать основной workspace командой `nest new app`.
  - Сгенерировать приложения: `nest g app gateway`, `nest g app worker-ai`, `nest g app worker-git`, `nest g app frontend`.
  - Добавить общие библиотеки: `nest g lib domains` для доменной логики, `nest g lib shared-kernel` для DTO и утилит.
- Настроить инфраструктуру запуска и зависимости.
  - Добавить `docker-compose.yml` с сервисами (PostgreSQL, MinIO, Redis/BullMQ) и примерами томов для Git-хранилищ.
  - Подготовить `.env.example` для всех приложений, описав ключевые переменные окружения.
- Настроить систему событий: публикация задач, подписка воркеров, обработка ошибок.
- Определить общую библиотеку для повторно используемой логики (рендеринг markdown, доступ к БД, клиенты Git/MinIO).
- Обеспечить конфигурацию воркеров для мгновенной реакции на события и распределение тяжёлых операций в фон.

## Критерии приёмки
- Есть описание структуры пакетов и приложений в монорепе.
- Реализована минимальная очередь задач и обработчик воркера с тестами.
- Настроены общие интерфейсы и DTO для обмена между приложениями.
- Документация по запуску монорепы и воркеров присутствует.

## Implementation Details

**Структура монорепы**

- `apps/app` — ядро, предоставляет эндпоинт `/status` со сводкой по очереди и зарегистрированным воркерам.
- `apps/gateway` — HTTP-шлюз для постановки задач рендера, AI-анализов и других фоновых операций.
- `apps/worker-ai` — реактивный воркер для анализа источников; использует общую очередь и модуль Markdown.
- `apps/worker-git` — воркер для зеркалирования git-коммитов, работает с in-memory клиентом Git.
- `libs/shared-kernel` — общие DTO, очередь задач, клиенты Git/MinIO/PostgreSQL и Markdown-рендерер.
- `libs/domains` — доменная обвязка очереди: публикация задач и регистрация воркеров.

**Очередь задач**

Очередь реализована в `TaskQueueService` (RxJS). Любое приложение может публиковать сообщения через `DomainsService`. Воркеры регистрируются и автоматически снимаются с обработки при остановке. Ошибки попадают в стрим `errors()` и фиксируются ядром.

**Инфраструктура**

- `docker-compose.yml` поднимает PostgreSQL, Redis/BullMQ, MinIO и все Node-сервисы.
- `.env.example` описывает переменные окружения для всех приложений.

**Запуск**

```bash
cd app
npm install
npm run test     # прогон unit + e2e
# или поднять всю связку
cd ..
docker compose up --build
```

Для локальной разработки доступны отдельные скрипты `npm run start:gateway`, `npm run start:worker:ai`, `npm run start:worker:git`.

**Тесты**

Каждое приложение имеет unit и e2e тесты (Jest + Supertest), проверяющие эндпоинты и работу очереди.
